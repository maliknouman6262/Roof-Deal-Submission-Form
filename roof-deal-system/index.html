<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Roof Deal Submission</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .form-label { font-weight: bold; }
        .check-item:checked + label { text-decoration: line-through; color: gray; }
        .progress-vertical {
            width: 20px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            z-index: 1000;
        }
        .progress-vertical .progress-bar {
            width: 100%;
            transition: height 0.6s ease;
        }
        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
        }
        .alert {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="loading-spinner" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <div class="progress progress-vertical">
        <div class="progress-bar" role="progressbar" id="formProgress" style="height: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
    </div>

    <div class="container my-5">
        <header class="text-center mb-4">
            <h1>New Roof Deal Submission Form (v1.3)</h1>
            <p class="lead">A lightweight form for sales reps to submit new roof projects with standardized requirements.</p>
        </header>

        <div id="alertArea"></div>

        <form id="roofForm" enctype="multipart/form-data">
            <div class="card mb-4" data-section="customer">
                <div class="card-header bg-primary text-white">Customer Information</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="customerLookup" class="form-label">Customer Lookup *</label>
                        <input type="text" class="form-control" id="customerLookup" name="customerLookup" placeholder="Search by name, phone, or email" required>
                    </div>
                    <div class="mb-3">
                        <label for="customerName" class="form-label">Customer Name *</label>
                        <input type="text" class="form-control" id="customerName" name="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label for="address" class="form-label">Address *</label>
                        <input type="text" class="form-control" id="address" name="address" placeholder="Street, City, State, ZIP" required>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phone" class="form-label">Phone *</label>
                            <input type="tel" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email" class="form-control" id="email" name="email" required>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4" data-section="financing">
                <div class="card-header bg-primary text-white">Financing</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="financingType" class="form-label">Financing Type *</label>
                        <select class="form-select" id="financingType" name="financingType" required>
                            <option value="">Select...</option>
                            <option value="Cash">Cash (Self-Funded)</option>
                            <option value="Insurance">Insurance</option>
                            <option value="Loan">Loan</option>
                        </select>
                    </div>
                    <div id="cashInfo" class="mb-3" style="display: none;">
                        <div class="mb-3">
                            <label for="depositAmount" class="form-label">Deposit Amount *</label>
                            <input type="number" class="form-control" id="depositAmount" name="depositAmount">
                        </div>
                        <div class="mb-3">
                            <label for="paymentMethod" class="form-label">Payment Method *</label>
                            <select class="form-select" id="paymentMethod" name="paymentMethod">
                                <option value="">Select...</option>
                                <option value="Check">Check</option>
                                <option value="Credit">Credit Card</option>
                                <option value="Pending Loan">Pending Personal Loan</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div id="checkInfo" style="display: none;">
                            <div class="mb-3">
                                <label for="checkNumber" class="form-label">Check Number *</label>
                                <input type="text" class="form-control" id="checkNumber" name="checkNumber">
                            </div>
                            <div class="mb-3">
                                <label for="checkFrontPhoto" class="form-label">Photo of Check Front *</label>
                                <input type="file" class="form-control" id="checkFrontPhoto" name="checkFrontPhoto" accept="image/*">
                            </div>
                            <div class="mb-3">
                                <label for="checkRearPhoto" class="form-label">Photo of Check Rear *</label>
                                <input type="file" class="form-control" id="checkRearPhoto" name="checkRearPhoto" accept="image/*">
                            </div>
                        </div>
                        <div id="creditInfo" style="display: none;">
                            <div class="mb-3">
                                <label for="authNumber" class="form-label">Authorization Number *</label>
                                <input type="text" class="form-control" id="authNumber" name="authNumber">
                            </div>
                            <div class="mb-3">
                                <label for="confirmNumber" class="form-label">Confirmation Number *</label>
                                <input type="text" class="form-control" id="confirmNumber" name="confirmNumber">
                            </div>
                            <div class="mb-3">
                                <label for="creditAmount" class="form-label">Amount *</label>
                                <input type="number" class="form-control" id="creditAmount" name="creditAmount">
                            </div>
                        </div>
                        <div id="pendingLoanInfo" style="display: none;">
                            <div class="mb-3">
                                <label for="bankDetails" class="form-label">Bank Details *</label>
                                <input type="text" class="form-control" id="bankDetails" name="bankDetails">
                            </div>
                        </div>
                    </div>
                    <div id="lenderInfo" class="mb-3" style="display: none;">
                        <label for="lenderName" class="form-label">Lender Name *</label>
                        <input type="text" class="form-control" id="lenderName" name="lenderName">
                        <label for="loanNumber" class="form-label mt-2">Loan # (optional)</label>
                        <input type="text" class="form-control" id="loanNumber" name="loanNumber">
                    </div>
                </div>
            </div>

            <div class="card mb-4" data-section="roof">
                <div class="card-header bg-primary text-white">Roof Details</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="roofType" class="form-label">Roof Type *</label>
                        <select class="form-select" id="roofType" name="roofType" required>
                            <option value="">Select...</option>
                            <option value="Asphalt">Asphalt (Tamko Shingles)</option>
                            <option value="Metal">Metal</option>
                            <option value="Tile">Tile</option>
                            <option value="Flat">Flat</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div id="roofMaterial" class="mb-3" style="display: none;">
                        <label for="roofMaterialType" class="form-label">Roof Material Type</label>
                        <select class="form-select" id="roofMaterialType" name="roofMaterialType">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div id="tamkoLine" class="mb-3" style="display: none;">
                        <label for="tamkoLineSelect" class="form-label">Tamko Line</label>
                        <select class="form-select" id="tamkoLineSelect" name="tamkoLineSelect">
                            <option value="">Select...</option>
                            <option value="Elite-Glass">Elite-Glass</option>
                            <option value="Heritage">Heritage</option>
                            <option value="TitanXT">TitanXT</option>
                            <option value="StormFighter Flex">StormFighter Flex</option>
                        </select>
                        <label for="tamkoColor" class="form-label mt-2">Color</label>
                        <select class="form-select" id="tamkoColor" name="tamkoColor">
                            <option value="">Select...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="roofPitch" class="form-label">Roof Pitch *</label>
                        <select class="form-select" id="roofPitch" name="roofPitch" required>
                            <option value="">Select...</option>
                            <option value="Flat (0/12)">Flat (0/12)</option>
                            <option value="1/12">1/12</option>
                            <option value="2/12">2/12</option>
                            <option value="3/12">3/12</option>
                            <option value="4/12">4/12</option>
                            <option value="5/12">5/12</option>
                            <option value="6/12">6/12</option>
                            <option value="7/12">7/12</option>
                            <option value="8/12">8/12</option>
                            <option value="9/12">9/12</option>
                            <option value="10/12">10/12</option>
                            <option value="11/12">11/12</option>
                            <option value="12/12+">12/12+</option>
                            <option value="Custom">Custom</option>
                        </select>
                    </div>
                    <div id="customPitch" class="mb-3" style="display: none;">
                        <label for="customRise" class="form-label">Custom Rise over 12 (0-24)</label>
                        <input type="number" class="form-control" id="customRise" name="customRise" min="0" max="24">
                    </div>
                    <div class="mb-3">
                        <label for="soldSquares" class="form-label">Sold Number of Squares *</label>
                        <input type="number" class="form-control" id="soldSquares" name="soldSquares" required>
                    </div>
                    <div class="mb-3">
                        <label for="layers" class="form-label">Layers to Remove</label>
                        <select class="form-select" id="layers" name="layers">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="Unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="damageType" class="form-label">Damage Type</label>
                        <select class="form-select" id="damageType" name="damageType">
                            <option value="Storm">Storm</option>
                            <option value="Age">Age</option>
                            <option value="Leak">Leak</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="insuranceClaim" class="form-label">Insurance Claim? *</label>
                        <select class="form-select" id="insuranceClaim" name="insuranceClaim" required>
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>
                    <div id="insuranceInfo" style="display: none;">
                        <div class="mb-3">
                            <label for="insuranceName" class="form-label">Insurance Name *</label>
                            <input type="text" class="form-control" id="insuranceName" name="insuranceName">
                        </div>
                        <div class="mb-3">
                            <label for="insurancePhone" class="form-label">Insurance Phone Number *</label>
                            <input type="tel" class="form-control" id="insurancePhone" name="insurancePhone">
                        </div>
                        <div class="mb-3">
                            <label for="policyNumber" class="form-label">Policy Number *</label>
                            <input type="text" class="form-control" id="policyNumber" name="policyNumber">
                        </div>
                        <div class="mb-3">
                            <label for="claimNumber" class="form-label">Claim # *</label>
                            <input type="text" class="form-control" id="claimNumber" name="claimNumber">
                        </div>
                        <div class="mb-3">
                            <label for="adjusterInfo" class="form-label">Adjuster Info *</label>
                            <input type="text" class="form-control" id="adjusterInfo" name="adjusterInfo">
                        </div>
                        <div class="mb-3">
                            <label for="coverageDoc" class="form-label">Upload Coverage Document *</label>
                            <input type="file" class="form-control" id="coverageDoc" name="coverageDoc" accept=".pdf">
                        </div>
                        <div class="mb-3">
                            <label for="binderDoc" class="form-label">Upload Binder *</label>
                            <input type="file" class="form-control" id="binderDoc" name="binderDoc" accept=".pdf">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4" data-section="contract">
                <div class="card-header bg-primary text-white">Contract</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="contractSource" class="form-label">Contract Source *</label>
                        <select class="form-select" id="contractSource" name="contractSource" required>
                            <option value="">Select...</option>
                            <option value="Upload PDF">Upload PDF</option>
                            <option value="OpenSign Lookup">OpenSign Lookup</option>
                        </select>
                    </div>
                    <div id="uploadPDF" style="display: none;">
                        <label for="contractPDF" class="form-label">Contract PDF *</label>
                        <input type="file" class="form-control" id="contractPDF" name="contractPDF" accept=".pdf">
                    </div>
                    <div id="openSign" style="display: none;">
                        <div class="mb-3">
                            <label for="openSignID" class="form-label">OpenSign Envelope/Doc ID *</label>
                            <input type="text" class="form-control" id="openSignID" name="openSignID">
                        </div>
                        <div class="mb-3">
                            <label for="openSignStatus" class="form-label">Status</label>
                            <select class="form-select" id="openSignStatus" name="openSignStatus">
                                <option value="Draft">Draft</option>
                                <option value="Sent">Sent</option>
                                <option value="Signed">Signed</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="openSignLink" class="form-label">OpenSign Link (read-only)</label>
                            <input type="text" class="form-control" id="openSignLink" name="openSignLink" readonly>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mb-4" data-section="photos">
                <div class="card-header bg-primary text-white">Required Photos</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="frontPhoto" class="form-label">Front of Home *</label>
                        <input type="file" class="form-control" id="frontPhoto" name="frontPhoto" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label for="rearPhoto" class="form-label">Rear of Home *</label>
                        <input type="file" class="form-control" id="rearPhoto" name="rearPhoto" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label for="leftPhoto" class="form-label">Left Side of Home *</label>
                        <input type="file" class="form-control" id="leftPhoto" name="leftPhoto" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label for="rightPhoto" class="form-label">Right Side of Home *</label>
                        <input type="file" class="form-control" id="rightPhoto" name="rightPhoto" accept="image/*" required>
                    </div>
                    <div class="mb-3">
                        <label for="signPhoto" class="form-label">"I just ordered my roof with Triguard" Sign *</label>
                        <input type="file" class="form-control" id="signPhoto" name="signPhoto" accept="image/*" required>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="mediaConsent" name="mediaConsent">
                        <label class="form-check-label" for="mediaConsent">Media Consent (optional - use for marketing)</label>
                    </div>
                </div>
            </div>

            <div class="card mb-4" data-section="survey">
                <div class="card-header bg-primary text-white">Survey & Notes</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="surveyDate" class="form-label">Property Site Survey Date *</label>
                        <input type="date" class="form-control" id="surveyDate" name="surveyDate" required>
                    </div>
                    <div class="mb-3">
                        <label for="surveySlot" class="form-label">Time Slot *</label>
                        <select class="form-select" id="surveySlot" name="surveySlot" required>
                            <option value="">Select...</option>
                            <option value="Morning (8am - 12pm)">Morning (8am - 12pm)</option>
                            <option value="Afternoon (12pm - 4pm)">Afternoon (12pm - 4pm)</option>
                            <option value="Evening (4pm - 8pm)">Evening (4pm - 8pm)</option>
                        </select>
                    </div>
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="needsScheduling" name="needsScheduling">
                        <label class="form-check-label" for="needsScheduling">Needs Scheduling</label>
                    </div>
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="3"></textarea>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header bg-primary text-white">Pre-Submit Checklist</div>
                <div class="card-body">
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input check-item" id="checkCustomer" disabled>
                        <label class="form-check-label" for="checkCustomer">Customer info complete and accurate</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input check-item" id="checkFinancing" disabled>
                        <label class="form-check-label" for="checkFinancing">Financing details entered (if applicable)</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input check-item" id="checkRoofDetails" disabled>
                        <label class="form-check-label" for="checkRoofDetails">Roof details and material selected</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input check-item" id="checkContract" disabled>
                        <label class="form-check-label" for="checkContract">Contract uploaded or referenced</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input check-item" id="checkPhotos" disabled>
                        <label class="form-check-label" for="checkPhotos">All 5 required photos uploaded</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input check-item" id="checkSurvey" disabled>
                        <label class="form-check-label" for="checkSurvey">Survey date selected or flagged for scheduling</label>
                    </div>
                </div>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                <button type="button" class="btn btn-secondary">Cancel</button>
                <button type="button" class="btn btn-warning">Save Draft</button>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>

    <script>
        // Mapping of conditional fields to their parent container IDs
        const conditionalFields = {
            'checkInfo': ['checkNumber', 'checkFrontPhoto', 'checkRearPhoto'],
            'creditInfo': ['authNumber', 'confirmNumber', 'creditAmount'],
            'pendingLoanInfo': ['bankDetails'],
            'lenderInfo': ['lenderName'],
            'insuranceInfo': ['insuranceName', 'insurancePhone', 'policyNumber', 'claimNumber', 'adjusterInfo', 'coverageDoc', 'binderDoc'],
            'uploadPDF': ['contractPDF'],
            'openSign': ['openSignID']
        };

        // Function to check if an element is visible
        function isVisible(el) {
            return el && el.offsetParent !== null;
        }

        // Function to check if a field is empty
        function isFieldEmpty(field) {
            if (field.type === 'file') {
                return field.files.length === 0;
            } else if (field.tagName === 'SELECT') {
                return field.value === '';
            } else {
                return field.value.trim() === '';
            }
        }

        // Function to find all visible and required fields
        function getVisibleRequiredFields() {
            const requiredFields = Array.from(document.querySelectorAll('[required]'));
            const visibleRequiredFields = requiredFields.filter(field => isVisible(field));

            // Also check for conditionally required fields
            for (const parentId in conditionalFields) {
                const parentEl = document.getElementById(parentId);
                if (isVisible(parentEl)) {
                    conditionalFields[parentId].forEach(fieldId => {
                        const field = document.getElementById(fieldId);
                        if (field) {
                            visibleRequiredFields.push(field);
                        }
                    });
                }
            }
            return visibleRequiredFields;
        }

        // Function to show alerts
        function showAlert(message, type) {
            const alertArea = document.getElementById('alertArea');
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            alertArea.innerHTML = alertHtml;
            // Auto dismiss after 5 seconds
            setTimeout(() => {
                const alert = alertArea.querySelector('.alert');
                if (alert) {
                    alert.classList.remove('show');
                    setTimeout(() => alert.remove(), 150);
                }
            }, 5000);
        }

        // Conditional Logic for Financing
        document.getElementById('financingType').addEventListener('change', function() {
            document.getElementById('cashInfo').style.display = this.value === 'Cash' ? 'block' : 'none';
            document.getElementById('lenderInfo').style.display = this.value === 'Loan' ? 'block' : 'none';
        });

        // Conditional Logic for Payment Method
        document.getElementById('paymentMethod').addEventListener('change', function() {
            document.getElementById('checkInfo').style.display = this.value === 'Check' ? 'block' : 'none';
            document.getElementById('creditInfo').style.display = this.value === 'Credit' ? 'block' : 'none';
            document.getElementById('pendingLoanInfo').style.display = this.value === 'Pending Loan' ? 'block' : 'none';
        });

        // Conditional Logic for Insurance
        document.getElementById('insuranceClaim').addEventListener('change', function() {
            document.getElementById('insuranceInfo').style.display = this.value === 'Yes' ? 'block' : 'none';
        });

        // Conditional Logic for Contract Source
        document.getElementById('contractSource').addEventListener('change', function() {
            document.getElementById('uploadPDF').style.display = this.value === 'Upload PDF' ? 'block' : 'none';
            document.getElementById('openSign').style.display = this.value === 'OpenSign Lookup' ? 'block' : 'none';
        });

        // Conditional Logic for Roof Type and Material
        document.getElementById('roofType').addEventListener('change', function() {
            const materialSelect = document.getElementById('roofMaterialType');
            materialSelect.options.length = 0;
            materialSelect.add(new Option('Select...', ''));
            document.getElementById('roofMaterial').style.display = this.value !== 'Asphalt' ? 'block' : 'none';
            document.getElementById('tamkoLine').style.display = this.value === 'Asphalt' ? 'block' : 'none';
            if (this.value === 'Metal') {
                materialSelect.add(new Option('Stand and Seam', 'Stand and Seam'));
                materialSelect.add(new Option('Metal Shingle', 'Metal Shingle'));
            } else if (this.value === 'Flat') {
                materialSelect.add(new Option('TPO', 'TPO'));
                materialSelect.add(new Option('DURALAST', 'DURALAST'));
                materialSelect.add(new Option('MODIFIED', 'MODIFIED'));
            } else if (this.value === 'Other') {
                materialSelect.add(new Option('Other', 'Other'));
            }
        });

        // Conditional Logic for Tamko Line and Colors
        document.getElementById('tamkoLineSelect').addEventListener('change', function() {
            const colorSelect = document.getElementById('tamkoColor');
            colorSelect.options.length = 0;
            colorSelect.innerHTML = '<option value="">Select...</option>';
            if (this.value === 'Elite-Glass') {
                const colors = ['Oxford Grey', 'Rustic Black', 'Rustic Cedar', 'Rustic Hickory', 'Shadow Grey', 'Weathered Wood'];
                colors.forEach(color => colorSelect.add(new Option(color, color)));
            } else if (this.value === 'Heritage') {
                const colors = ['Antique Slate', 'Olde English Pewter', 'Oxford Grey', 'Rustic Black', 'Rustic Cedar', 'Rustic Hickory'];
                colors.forEach(color => colorSelect.add(new Option(color, color)));
            } else if (this.value === 'TitanXT') {
                colorSelect.innerHTML += '<optgroup label="Standard Colors">';
                const standard = ['Antique Slate', 'Olde English Pewter', 'Oxford Grey', 'Rustic Black', 'Rustic Cedar', 'Black Walnut', 'Mountain Slate', 'Natural Timber', 'Painted Desert', 'Weathered Wood'];
                standard.forEach(color => colorSelect.innerHTML += `<option value="${color}">${color}</option>`);
                colorSelect.innerHTML += '</optgroup>';
                colorSelect.innerHTML += '<optgroup label="Special Order">';
                const special = ['Rustic Evergreen', 'Rustic Hickory', 'Rustic Slate', 'Thunderstorm Grey'];
                special.forEach(color => colorSelect.innerHTML += `<option value="${color}">${color}</option>`);
                colorSelect.innerHTML += '</optgroup>';
            } else if (this.value === 'StormFighter Flex') {
                const colors = ['Black Walnut', 'Olde English Pewter', 'Rustic Black', 'Rustic Cedar', 'Rustic Slate', 'Thunderstorm Grey', 'Weathered Wood'];
                colors.forEach(color => colorSelect.add(new Option(color, color)));
            }
        });

        // Conditional Logic for Roof Pitch
        document.getElementById('roofPitch').addEventListener('change', function() {
            document.getElementById('customPitch').style.display = this.value === 'Custom' ? 'block' : 'none';
        });

        // Form Submission
        document.getElementById('roofForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Custom validation logic
            const visibleRequiredFields = getVisibleRequiredFields();
            const emptyFields = visibleRequiredFields.filter(field => isFieldEmpty(field));

            if (emptyFields.length > 0) {
                const firstEmptyField = emptyFields[0];
                const fieldName = firstEmptyField.previousElementSibling.textContent.replace('*', '').trim() || firstEmptyField.name;
                showAlert(`Please fill out the following field: ${fieldName}`, 'warning');
                firstEmptyField.focus();
                return; // Stop submission
            }
            
            // Show loading spinner
            document.getElementById('loadingSpinner').style.display = 'block';
            
            try {
                const formData = new FormData(this);
                
                console.log('Submitting form...');
                
                const response = await fetch('http://localhost:5000/submit-roof-deal', {
                    method: 'POST',
                    body: formData
                });
                
                console.log('Response status:', response.status);
                
                const result = await response.json();
                
                console.log('Response data:', result);
                
                if (response.ok) { // Check for a successful HTTP status code
                    showAlert(`Form submitted successfully! Deal ID: ${result.deal_id}`, 'success');
                    // Reset form
                    this.reset();
                    // Reset conditional fields visibility
                    document.getElementById('cashInfo').style.display = 'none';
                    document.getElementById('lenderInfo').style.display = 'none';
                    document.getElementById('insuranceInfo').style.display = 'none';
                    document.getElementById('uploadPDF').style.display = 'none';
                    document.getElementById('openSign').style.display = 'none';
                    document.getElementById('roofMaterial').style.display = 'none';
                    document.getElementById('tamkoLine').style.display = 'none';
                    document.getElementById('customPitch').style.display = 'none';
                    updateProgress();
                } else {
                    showAlert(`Error: ${result.message}`, 'danger');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                showAlert(`Error: ${error.message}`, 'danger');
            } finally {
                // Hide loading spinner
                document.getElementById('loadingSpinner').style.display = 'none';
            }
        });

        // Progress Bar and Checklist Auto-Update
        const sections = ['customer', 'financing', 'roof', 'contract', 'photos', 'survey'];
        const checklistIds = {
            customer: 'checkCustomer',
            financing: 'checkFinancing',
            roof: 'checkRoofDetails',
            contract: 'checkContract',
            photos: 'checkPhotos',
            survey: 'checkSurvey'
        };
        
        // This function now relies on the `required` attribute and visibility
        function updateProgress() {
            let completed = 0;
            sections.forEach(section => {
                const sectionEl = document.querySelector(`[data-section="${section}"]`);
                const allFields = Array.from(sectionEl.querySelectorAll('input, select, textarea'));
                const requiredAndVisibleFields = allFields.filter(field => field.hasAttribute('required') || (isVisible(field.closest('.mb-3'))));
                
                const isSectionComplete = requiredAndVisibleFields.every(field => !isFieldEmpty(field));

                const checklistField = document.getElementById(checklistIds[section]);
                if (checklistField) {
                    checklistField.checked = isSectionComplete;
                }
                
                if (isSectionComplete) {
                    completed++;
                }
            });

            const progress = (completed / sections.length) * 100;
            const progressBar = document.getElementById('formProgress');
            if (progressBar) {
                progressBar.style.height = `${progress}%`;
                progressBar.setAttribute('aria-valuenow', progress);
            }
        }

        // Listen for changes in the form
        document.getElementById('roofForm').addEventListener('input', updateProgress);
        document.getElementById('roofForm').addEventListener('change', updateProgress);

        // Initial update
        updateProgress();
        // Set min and max for survey date (within 48 hours)
        const surveyDateInput = document.getElementById('surveyDate');
        const today = new Date();
        const minDate = new Date(today);
        const maxDate = new Date(today);
        maxDate.setHours(today.getHours() + 48);
        surveyDateInput.min = minDate.toISOString().split('T')[0];
        surveyDateInput.max = maxDate.toISOString().split('T')[0];
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>